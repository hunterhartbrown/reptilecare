<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Care Guides - ReptileCare</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
        }
        header {
            background-color: #ffffff;
            width: 100%;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            z-index: 1000;
        }
        header img.logo {
            height: 65px;
            transform-origin: bottom right;
        }
        nav {
            flex: 1;
            display: flex;
            justify-content: center;
        }
        .nav-links {
            list-style: none;
            display: flex;
            gap: 20px;
            margin: 0;
            padding: 0;
        }
        .nav-links li {
            display: inline-block;
        }
        .nav-links a {
            text-decoration: none;
            color: #222;
            font-size: 1rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 5px;
            transition: background 0.2s, color 0.2s;
        }
        .nav-links a:hover,
        .nav-links a:focus {
            background: #0f0f0f;
            color: #fff;
        }
        .auth-buttons {
            display: flex;
            gap: 10px;
        }
        .auth-buttons .login,
        .auth-buttons .signup {
            font-family: 'Open Sans', Arial, sans-serif;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 6px;
            border: 1px solid #0f0f0f;
            padding: 6px 16px;
            background: #fff;
            color: #0f0f0f;
            cursor: pointer;
            transition: background 0.18s, color 0.18s, border 0.18s;
        }
        .auth-buttons .signup {
            background: #0f0f0f;
            color: #fff;
            border: 1px solid #0f0f0f;
        }
        .auth-buttons .signup:hover, .auth-buttons .signup:focus {
            background: #444;
            color: #fff;
            border: 1px solid #0f0f0f;
        }
        .auth-buttons .login:hover, .auth-buttons .login:focus {
            background: #0f0f0f;
            color: #fff;
            border: 1px solid #222;
        }
        /* --- Care Guide Styles --- */
        .care-guides {
            padding: 120px 8px 12px;
            background-color: #0f0f0f;
            color: #fff;
            min-height: 100vh;
        }
        .care-guides-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 0 8px 0;
            font-family: 'Open Sans', Arial, sans-serif;
        }
        .care-guides-desc {
            text-align: center;
            font-size: 1.2rem;
            font-weight: 400;
            margin: 0 0 24px 0;
            font-family: 'Open Sans', Arial, sans-serif;
        }
        .care-guide-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px 14px;
        }
        .care-guide {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            width: 210px;
            min-width: 180px;
            max-width: 250px;
            /* min-height: 320px;  REMOVE THIS LINE */
            padding: 10px 12px 10px 12px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 1.5px 3px rgba(0,0,0,0.03);
            text-decoration: none;
            transition: box-shadow 0.2s, transform 0.18s;
            position: relative;
        }
        .care-guide:focus,
        .care-guide:hover {
            box-shadow: 0 8px 32px rgba(0,0,0,0.17), 0 3px 8px rgba(0,0,0,0.08);
            transform: translateY(-3px) scale(1.03);
            outline: none;
        }
        .care-guide-img-frame {
            width: 100%;
            height: 90px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f4f4f4;
            border-radius: 7px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        .care-guide-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }
        .care-guide-label {
            font-size: 1.07rem;
            font-weight: 700;
            color: #222;
            margin: 0 0 7px 0;
            height: 44px; /* Fixed height to accommodate up to 2 lines */
            max-width: 95%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Open Sans', Arial, sans-serif;
            text-align: center;
            white-space: normal;
            word-break: break-word;
            line-height: 1.15;
            overflow: hidden;
        }
        .availability-row {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 0;
            margin-top: 0;
        }
        .availability-bar {
            display: flex;
            gap: 2px;
            margin-bottom: 5px;
            margin-top: 0;
            justify-content: center;
        }
        .availability-value {
            font-size: 0.99rem;
            color: #444;
            font-family: 'Open Sans', Arial, sans-serif;
            text-align: center;
            margin-bottom: 0;
            margin-top: 0;
        }
        .care-guide-btn-row {
            display: flex;
            gap: 8px;
            margin-top: 12px;    /* Add more space above buttons */
            margin-bottom: 0;    /* Remove all space below buttons */
            width: 100%;
            justify-content: center;
        }
        .care-guide-btn {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Open Sans', Arial, sans-serif;
            font-size: 1rem;
            font-weight: 600;
            padding: 6px 4px 6px 4px;
            width: 120px;
            min-width: 0;
            height: auto;
            border-radius: 6px;
            border: 1.3px solid #0f0f0f;
            background: #fff;
            color: #0f0f0f;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.18s, color 0.18s, border 0.18s;
            text-align: center;
            box-sizing: border-box;
            margin-bottom: 0;
        }
        .care-guide-btn:hover, .care-guide-btn:focus {
            background: #0f0f0f;
            color: #fff;
            border: 1.3px solid #222;
            outline: none;
        }
        .care-guide-btn.secondary {
            background: #0f0f0f;
            color: #fff;
            border: 1.3px solid #0f0f0f;
        }
        .care-guide-btn.secondary:hover, .care-guide-btn.secondary:focus {
            background: #444;
            color: #fff;
            border: 1.3px solid #0f0f0f;
        }
        @media (max-width: 900px) {
            .care-guide-container {
                gap: 15px 5px;
            }
            .care-guide {
                width: 43vw;
                min-width: 110px;
                max-width: 230px;
                /* min-height: 175px; REMOVE THIS TOO IF PRESENT */
            }
        }
        @media (max-width: 600px) {
            .care-guides {
                padding: 84px 2px 8px 2px;
            }
            .care-guide-container {
                gap: 10px 0;
            }
            .care-guide {
                width: 92vw;
                min-width: 90px;
                max-width: 98vw;
                padding: 8px 2px 8px 2px;
                /* min-height: 175px; REMOVE THIS TOO IF PRESENT */
            }
            .care-guides-title { font-size: 1.25rem; }
            .care-guides-desc { font-size: 0.98rem; }
            .care-guide-img-frame { 
                height: 0;
                padding-bottom: 42.86%; /* This maintains the same 2.33:1 aspect ratio as desktop (90px/210px) */
                position: relative;
            }
            .care-guide-img {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
            .availability-segment { width: 9px; height: 6px; }
            .care-guide-label { min-height: 20px; font-size: 0.99rem; }
            .care-guide-btn {
                width: 42vw;
                min-width: 45px;
                font-size: 0.96rem;
                padding: 5px 0 5px 0;
            }
            .care-guide-btn-row {
                margin-top: 8px;
            }
        }
        .availability-segment {
            width: 13px;
            height: 10px;
            border-radius: 2.5px;
            background: #e0e0e0;
            transition: background 0.3s;
        }
        .availability-segment.active {
            background: #37b24d;
        }
        footer {
            background-color: #fff;
            color: #0f0f0f;
            padding: 20px;
            text-align: left;
            border-top: 1px solid #ddd;
            margin-left: 20px;
            position: relative;
            font-family: 'Open Sans', Arial, sans-serif;
        }
    </style>
</head>
<body>
    <header id="main-header"></header>
    <section class="care-guides">
        <h1 class="care-guides-title">All Care Guides</h1>
        <p class="care-guides-desc">Here you can find all the care guides for various reptiles.</p>
        
        <!-- rc: care-guides additive start -->
        <!-- Mobile Filters Toggle Button -->
        <button type="button" data-rc-cg="filters-toggle" class="rc-filters-toggle" aria-label="Open filters">
            <span class="rc-filters-toggle-text">Filters</span>
            <span class="rc-filters-toggle-count" id="rc-active-filter-count"></span>
        </button>

        <!-- Mobile Filters Drawer -->
        <div data-rc-cg="sidebar-panel" class="rc-sidebar-panel" hidden aria-hidden="true" role="dialog" aria-modal="true" aria-label="Filters">
            <div class="rc-sidebar-panel-header">
                <h2 class="rc-sidebar-panel-title">Filters</h2>
                <button type="button" data-rc-cg="panel-close" class="rc-panel-close" aria-label="Close filters">×</button>
            </div>
            <div class="rc-sidebar-panel-content">
                <!-- Mobile filters content will be populated by JS -->
            </div>
        </div>

        <!-- Two-Column Layout -->
        <div data-rc-cg="layout" class="rc-layout">
            <!-- Sticky Left Sidebar -->
            <aside data-rc-cg="sidebar" class="rc-sidebar" role="complementary" aria-label="Care guide filters">
                <div class="rc-sidebar-content">
                    <h2 class="rc-sidebar-title">Filters</h2>
                    
                    <!-- Result Count -->
                    <div class="rc-result-count" aria-live="polite" id="rc-result-count">Loading...</div>
                    
                    <!-- Difficulty Filter -->
                    <div class="rc-filter-section">
                        <h3 class="rc-filter-section-title">Difficulty</h3>
                        <div class="rc-filter-chips">
                            <button type="button" class="rc-chip rc-chip--active" data-filter-type="difficulty" data-filter-value="all" aria-pressed="true">All</button>
                            <button type="button" class="rc-chip" data-filter-type="difficulty" data-filter-value="beginner" aria-pressed="false">Beginner</button>
                            <button type="button" class="rc-chip" data-filter-type="difficulty" data-filter-value="intermediate" aria-pressed="false">Intermediate</button>
                            <button type="button" class="rc-chip" data-filter-type="difficulty" data-filter-value="advanced" aria-pressed="false">Advanced</button>
                        </div>
                    </div>

                    <!-- Habitat Filter -->
                    <div class="rc-filter-section">
                        <h3 class="rc-filter-section-title">Habitat</h3>
                        <div class="rc-filter-chips">
                            <button type="button" class="rc-chip" data-filter-type="habitat" data-filter-value="arid" aria-pressed="false">Arid</button>
                            <button type="button" class="rc-chip" data-filter-type="habitat" data-filter-value="tropical" aria-pressed="false">Tropical</button>
                            <button type="button" class="rc-chip" data-filter-type="habitat" data-filter-value="temperate" aria-pressed="false">Temperate</button>
                        </div>
                    </div>

                    <!-- Lifespan Filter -->
                    <div class="rc-filter-section">
                        <h3 class="rc-filter-section-title">Lifespan</h3>
                        <div class="rc-filter-chips">
                            <button type="button" class="rc-chip" data-filter-type="lifespan" data-filter-value="short" aria-pressed="false">5-10 years</button>
                            <button type="button" class="rc-chip" data-filter-type="lifespan" data-filter-value="medium" aria-pressed="false">10-15 years</button>
                            <button type="button" class="rc-chip" data-filter-type="lifespan" data-filter-value="long" aria-pressed="false">15+ years</button>
                        </div>
                    </div>

                    <!-- Temperament Filter -->
                    <div class="rc-filter-section">
                        <h3 class="rc-filter-section-title">Temperament</h3>
                        <div class="rc-filter-chips">
                            <button type="button" class="rc-chip" data-filter-type="temperament" data-filter-value="docile" aria-pressed="false">Docile</button>
                            <button type="button" class="rc-chip" data-filter-type="temperament" data-filter-value="moderate" aria-pressed="false">Moderate</button>
                            <button type="button" class="rc-chip" data-filter-type="temperament" data-filter-value="defensive" aria-pressed="false">Defensive</button>
                        </div>
                    </div>

                    <!-- Size Filter -->
                    <div class="rc-filter-section">
                        <h3 class="rc-filter-section-title">Size</h3>
                        <div class="rc-filter-chips">
                            <button type="button" class="rc-chip" data-filter-type="size" data-filter-value="small" aria-pressed="false">Small (&lt; 8")</button>
                            <button type="button" class="rc-chip" data-filter-type="size" data-filter-value="medium" aria-pressed="false">Medium (8-18")</button>
                            <button type="button" class="rc-chip" data-filter-type="size" data-filter-value="large" aria-pressed="false">Large (18"+)</button>
                        </div>
                    </div>

                    <!-- Clear All Button -->
                    <button type="button" class="rc-clear-all-btn" id="rc-clear-all-filters">Clear All Filters</button>
                </div>
            </aside>

            <!-- Main Content Area -->
            <div data-rc-cg="grid-wrap" class="rc-grid-wrap">
                <div class="care-guide-container" id="care-guides-list" data-rc-cg="grid"></div>
                
                <!-- Pagination Controls -->
                <div data-rc-cg="pagination" class="rc-pagination" id="rc-pagination" style="display: none;">
                    <button type="button" class="rc-page-btn rc-page-prev" id="rc-prev-btn" aria-label="Previous page">
                        ‹ Prev
                    </button>
                    <div class="rc-page-numbers" id="rc-page-numbers"></div>
                    <button type="button" class="rc-page-btn rc-page-next" id="rc-next-btn" aria-label="Next page">
                        Next ›
                    </button>
                </div>
            </div>
        </div>
        <!-- rc: care-guides additive end -->
    </section>
    <div id="main-footer"></div>
    <!-- Mobile Menu JavaScript (loads header and handles mobile menu functionality) -->
    <script src="js/mobile-menu.js"></script>
    <!-- Enhanced Care Guides with Sidebar Script -->
    <script>
        // ===== CONFIGURATION =====
        const PAGE_SIZE = 24;
        
        // Availability thresholds and tinting
        const AVAILABILITY_THRESHOLDS = {
          high: 200,    // >= 200 = neutral/standard
          medium: 50,   // 50-199 = warning tint  
          low: 0        // < 50 = stronger tint
        };
        
        const thresholds = [
          { min: 1000, label: "Very Common", segments: 5 },
          { min: 200,  label: "Common",      segments: 4 },
          { min: 50,   label: "Uncommon",    segments: 3 },
          { min: 20,   label: "Rare",        segments: 2 },
          { min: 5,    label: "Very Rare",   segments: 1 },
          { min: 0,    label: "Exceedingly Rare", segments: 0 }
        ];

        // Species data mapping (additive inline mapping for filtering)
        const speciesData = {
          "Leopard Gecko": {
            img: "images/leo trans bg.png",
            url: "/leopard-gecko.html",
            enclosureId: "leopard-gecko",
            difficulty: "beginner",
            habitat: "arid",
            lifespan: "medium", // 10-15 years
            temperament: "docile",
            size: "small"
          },
          "Bearded Dragon": {
            img: "images/bearded drag trans bg.png", 
            url: "/bearded-dragon.html",
            enclosureId: "bearded-dragon",
            difficulty: "beginner",
            habitat: "arid",
            lifespan: "medium", // 10-15 years
            temperament: "docile",
            size: "large"
          },
          "Crested Gecko": {
            img: "images/crested gecko trans bg.png",
            url: "/crested-gecko.html", 
            enclosureId: "crested-gecko",
            difficulty: "beginner",
            habitat: "tropical",
            lifespan: "medium", // 10-15 years
            temperament: "moderate",
            size: "small"
          },
          "Eastern Collared Lizard": {
            img: "images/collared lizard trans bg.png",
            url: "/eastern-collared-lizard.html",
            enclosureId: "eastern-collared-lizard", 
            difficulty: "advanced",
            habitat: "arid",
            lifespan: "short", // 5-10 years
            temperament: "defensive",
            size: "medium"
          }
        };

        // Cross-link test species (4 representative ones)
        const crossLinkSpecies = ["Leopard Gecko", "Bearded Dragon", "Crested Gecko", "Eastern Collared Lizard"];

        // ===== STATE MANAGEMENT =====
        let allAnimals = [];
        let filteredAnimals = [];
        let currentPage = 1;
        let activeFilters = {
          difficulty: "all",
          habitat: [],
          lifespan: [],
          temperament: [], 
          size: []
        };

        // Mobile drawer state
        let mobileDrawerOpen = false;
        let focusableElements = [];
        let firstFocusableElement = null;
        let lastFocusableElement = null;

        // ===== STICKY POSITIONING =====
        function updateStickyOffset() {
          const header = document.querySelector('header') || document.querySelector('#main-header');
          const offset = header ? (header.getBoundingClientRect().height + 16) : 16;
          document.documentElement.style.setProperty('--rc-sticky-top', `${offset}px`);
        }

        // ===== UTILITY FUNCTIONS =====
        function getAvailability(listings) {
          for (let t of thresholds) {
            if (listings >= t.min) return t;
          }
          return thresholds[thresholds.length - 1];
        }

        function getAvailabilityTint(listings) {
          if (typeof listings !== 'number' || isNaN(listings)) return 'rc-badge--high';
          if (listings >= AVAILABILITY_THRESHOLDS.high) return 'rc-badge--high';
          if (listings >= AVAILABILITY_THRESHOLDS.medium) return 'rc-badge--med';
          return 'rc-badge--low';
        }

        function getActiveFilterCount() {
          let count = 0;
          if (activeFilters.difficulty !== "all") count++;
          count += activeFilters.habitat.length;
          count += activeFilters.lifespan.length;
          count += activeFilters.temperament.length;
          count += activeFilters.size.length;
          return count;
        }

        function updateFilterCount() {
          const count = getActiveFilterCount();
          const countEl = document.getElementById('rc-active-filter-count');
          if (countEl) {
            countEl.textContent = count > 0 ? count : '';
          }
        }

        function updateResultCount() {
          const count = filteredAnimals.length;
          const countEl = document.getElementById('rc-result-count');
          if (countEl) {
            countEl.textContent = `${count} result${count !== 1 ? 's' : ''}`;
          }
        }

        // ===== CARD BUILDING =====
        function buildCareGuideCard(animal, listings, info) {
          let bar = '';
          let availText = '';
          let tintClass = '';
          
          if (typeof listings === 'number' && !isNaN(listings)) {
            const availability = getAvailability(listings);
            tintClass = getAvailabilityTint(listings);
            for (let i = 0; i < 5; ++i)
              bar += `<span class="availability-segment${i < availability.segments ? ' active' : ''}"></span>`;
            availText = `${listings} - ${availability.label}`;
          } else {
            tintClass = 'rc-badge--high';
            for (let i = 0; i < 5; ++i)
              bar += `<span class="availability-segment"></span>`;
            availText = "No Data";
          }

          // Cross-link test addition
          const crossLinkHTML = crossLinkSpecies.includes(animal) 
            ? `<a href="/enclosure-builder.html?reptile=${info.enclosureId}" class="rc-cross-link">Start enclosure plan →</a>` 
            : '';

          return `
          <div class="care-guide" 
               data-animal="${animal}"
               data-rc-difficulty="${info.difficulty}"
               data-rc-habitat="${info.habitat}"
               data-rc-lifespan="${info.lifespan}"
               data-rc-temperament="${info.temperament}"
               data-rc-size="${info.size}">
            <div class="care-guide-img-frame">
              <img src="${info.img}" alt="${animal}" class="care-guide-img" loading="lazy" width="210" height="90" onerror="this.onerror=null;this.src='images/no-image.png';">
            </div>
            <h3 class="care-guide-label js-animal-label">${animal}</h3>
            <div class="availability-row">
              <div class="availability-bar">${bar}</div>
              <span class="availability-value ${tintClass}">${availText}</span>
            </div>
            <div class="care-guide-btn-row">
              <a href="${info.url}" class="care-guide-btn secondary">
                View Care Guide
              </a>
              <a href="/enclosure-builder.html?reptile=${info.enclosureId}" class="care-guide-btn">
                Design an Enclosure
              </a>
            </div>
            ${crossLinkHTML}
          </div>
          `;
        }

        // ===== MOBILE DRAWER MANAGEMENT =====
        function populateMobileDrawer() {
          const mobileContent = document.querySelector('.rc-sidebar-panel-content');
          const desktopContent = document.querySelector('.rc-sidebar-content');
          if (mobileContent && desktopContent) {
            // Clone the filter sections to mobile drawer
            const filterSections = desktopContent.querySelectorAll('.rc-filter-section, .rc-clear-all-btn');
            mobileContent.innerHTML = '';
            filterSections.forEach(section => {
              mobileContent.appendChild(section.cloneNode(true));
            });
          }
        }

        function setupMobileDrawer() {
          const toggleBtn = document.querySelector('[data-rc-cg="filters-toggle"]');
          const drawer = document.querySelector('[data-rc-cg="sidebar-panel"]');
          const closeBtn = document.querySelector('[data-rc-cg="panel-close"]');

          if (!toggleBtn || !drawer || !closeBtn) return;

          function openDrawer() {
            mobileDrawerOpen = true;
            drawer.hidden = false;
            drawer.setAttribute('aria-hidden', 'false');
            
            // Populate drawer with current filter state
            populateMobileDrawer();
            syncFilterStates();
            setupMobileEventListeners();
            
            // Set up focus trap
            focusableElements = drawer.querySelectorAll(
              'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            firstFocusableElement = focusableElements[0];
            lastFocusableElement = focusableElements[focusableElements.length - 1];
            
            if (firstFocusableElement) {
              firstFocusableElement.focus();
            }
          }

          function closeDrawer() {
            mobileDrawerOpen = false;
            drawer.hidden = true;
            drawer.setAttribute('aria-hidden', 'true');
            toggleBtn.focus();
          }

          function handleKeydown(e) {
            if (!mobileDrawerOpen) return;

            if (e.key === 'Escape') {
              closeDrawer();
              return;
            }

            if (e.key === 'Tab') {
              if (e.shiftKey) {
                if (document.activeElement === firstFocusableElement) {
                  e.preventDefault();
                  lastFocusableElement.focus();
                }
              } else {
                if (document.activeElement === lastFocusableElement) {
                  e.preventDefault();
                  firstFocusableElement.focus();
                }
              }
            }
          }

          toggleBtn.addEventListener('click', openDrawer);
          closeBtn.addEventListener('click', closeDrawer);
          
          // Close on backdrop click
          drawer.addEventListener('click', function(e) {
            if (e.target === drawer) {
              closeDrawer();
            }
          });

          document.addEventListener('keydown', handleKeydown);
        }

        function syncFilterStates() {
          // Sync desktop and mobile filter states
          document.querySelectorAll('.rc-chip').forEach(chip => {
            const filterType = chip.dataset.filterType;
            const filterValue = chip.dataset.filterValue;
            
            if (filterType === 'difficulty') {
              const isActive = activeFilters.difficulty === filterValue;
              chip.classList.toggle('rc-chip--active', isActive);
              chip.setAttribute('aria-pressed', isActive);
            } else {
              const isActive = activeFilters[filterType].includes(filterValue);
              chip.classList.toggle('rc-chip--active', isActive);
              chip.setAttribute('aria-pressed', isActive);
            }
          });
        }

        function setupMobileEventListeners() {
          // Mobile filter event listeners
          document.querySelector('.rc-sidebar-panel-content').addEventListener('click', function(e) {
            if (e.target.matches('.rc-chip[data-filter-type]')) {
              handleFilterClick(e.target);
            }
            if (e.target.matches('.rc-clear-all-btn')) {
              clearAllFilters();
            }
          });
        }

        // ===== FILTERING & SORTING =====
        function filterAnimals() {
          filteredAnimals = allAnimals.filter(animal => {
            const data = speciesData[animal.name];
            
            // Check difficulty
            if (activeFilters.difficulty !== "all" && data.difficulty !== activeFilters.difficulty) {
              return false;
            }
            
            // Check multi-select filters
            const filterChecks = ['habitat', 'lifespan', 'temperament', 'size'];
            for (let filterType of filterChecks) {
              if (activeFilters[filterType].length > 0 && 
                  !activeFilters[filterType].includes(data[filterType])) {
                return false;
              }
            }
            
            return true;
          });
          
          // Sort alphabetically by common name
          filteredAnimals.sort((a, b) => a.name.localeCompare(b.name));
          
          currentPage = 1;
          updateResultCount();
          updateFilterCount();
          renderPage();
        }

        function handleFilterClick(chip) {
          const filterType = chip.dataset.filterType;
          const filterValue = chip.dataset.filterValue;
          
          if (filterType === 'difficulty') {
            // Handle difficulty (single select)
            activeFilters.difficulty = filterValue;
            
            // Update all difficulty chips
            document.querySelectorAll('.rc-chip[data-filter-type="difficulty"]').forEach(c => {
              const isActive = c.dataset.filterValue === filterValue;
              c.classList.toggle('rc-chip--active', isActive);
              c.setAttribute('aria-pressed', isActive);
            });
          } else {
            // Handle multi-select filters
            const isActive = activeFilters[filterType].includes(filterValue);
            
            if (isActive) {
              // Remove filter
              activeFilters[filterType] = activeFilters[filterType].filter(v => v !== filterValue);
              chip.classList.remove('rc-chip--active');
              chip.setAttribute('aria-pressed', 'false');
            } else {
              // Add filter
              activeFilters[filterType].push(filterValue);
              chip.classList.add('rc-chip--active');
              chip.setAttribute('aria-pressed', 'true');
            }
            
            // Sync same filter in other location (desktop/mobile)
            document.querySelectorAll(`.rc-chip[data-filter-type="${filterType}"][data-filter-value="${filterValue}"]`).forEach(c => {
              if (c !== chip) {
                c.classList.toggle('rc-chip--active', !isActive);
                c.setAttribute('aria-pressed', !isActive);
              }
            });
          }
          
          filterAnimals();
        }

        function clearAllFilters() {
          activeFilters = {
            difficulty: "all",
            habitat: [],
            lifespan: [],
            temperament: [],
            size: []
          };
          
          syncFilterStates();
          filterAnimals();
        }

        // ===== PAGINATION =====
        function getTotalPages() {
          return Math.ceil(filteredAnimals.length / PAGE_SIZE);
        }

        function renderPage() {
          const container = document.getElementById('care-guides-list');
          const startIdx = (currentPage - 1) * PAGE_SIZE;
          const endIdx = startIdx + PAGE_SIZE;
          const pageAnimals = filteredAnimals.slice(startIdx, endIdx);
          
          let html = '';
          pageAnimals.forEach(animal => {
            html += buildCareGuideCard(animal.name, animal.listings, speciesData[animal.name]);
          });
          
          container.innerHTML = html;
          uniformizeLabelFontSize();
          renderPagination();
          
          // Scroll to grid top when paginating
          if (currentPage > 1) {
            document.querySelector('[data-rc-cg="grid"]').scrollIntoView({ behavior: 'smooth' });
          }
        }

        function renderPagination() {
          const totalPages = getTotalPages();
          const paginationEl = document.getElementById('rc-pagination');
          const prevBtn = document.getElementById('rc-prev-btn');
          const nextBtn = document.getElementById('rc-next-btn');
          const numbersEl = document.getElementById('rc-page-numbers');
          
          if (totalPages <= 1) {
            paginationEl.style.display = 'none';
            return;
          }
          
          paginationEl.style.display = 'flex';
          
          // Previous/Next buttons
          prevBtn.disabled = currentPage === 1;
          nextBtn.disabled = currentPage === totalPages;
          
          // Page numbers
          let numbersHTML = '';
          for (let i = 1; i <= totalPages; i++) {
            const isActive = i === currentPage ? ' rc-page-active' : '';
            numbersHTML += `<button type="button" class="rc-page-num${isActive}" data-page="${i}">${i}</button>`;
          }
          numbersEl.innerHTML = numbersHTML;
        }

        // ===== EVENT HANDLERS =====
        function setupEventListeners() {
          // Desktop sidebar filter chips
          document.querySelector('[data-rc-cg="sidebar"]').addEventListener('click', function(e) {
            if (e.target.matches('.rc-chip[data-filter-type]')) {
              handleFilterClick(e.target);
            }
            if (e.target.matches('.rc-clear-all-btn')) {
              clearAllFilters();
            }
          });

          // Pagination
          document.addEventListener('click', function(e) {
            if (e.target.matches('#rc-prev-btn')) {
              if (currentPage > 1) {
                currentPage--;
                renderPage();
              }
            }
            
            if (e.target.matches('#rc-next-btn')) {
              if (currentPage < getTotalPages()) {
                currentPage++;
                renderPage();
              }
            }
            
            if (e.target.matches('.rc-page-num')) {
              currentPage = parseInt(e.target.dataset.page);
              renderPage();
            }
          });

          // Window resize handler for sticky offset
          window.addEventListener('resize', updateStickyOffset);
        }

        // Function to adjust label font size for uniform row heights
        function uniformizeLabelFontSize() {
          const labels = document.querySelectorAll('.js-animal-label');
          let fontSize = 1.07; // Starting font size in rem
          const minFontSize = 0.78; // Minimum font size in rem
          const step = 0.02; // Smaller step for more precise adjustment

          labels.forEach(label => {
            label.style.fontSize = fontSize + 'rem';
          });

          // Keep reducing font size until no label overflows
          let hasOverflow = true;
          while (hasOverflow && fontSize > minFontSize) {
            hasOverflow = false;
            labels.forEach(label => {
              if (label.scrollHeight > 44) { // 44px is our fixed height
                hasOverflow = true;
              }
            });
            
            if (hasOverflow) {
              fontSize -= step;
              labels.forEach(label => {
                label.style.fontSize = fontSize + 'rem';
              });
            }
          }
        }

        // ===== INITIALIZATION =====
        function init() {
          // Set up sticky positioning
          updateStickyOffset();
          
          // Set up mobile drawer
          setupMobileDrawer();
          
          fetch('data/availability.json')
            .then(response => response.json())
            .then(animals => {
              // Create a lookup map from the JSON
              const dataMap = {};
              animals.forEach(row => {
                dataMap[row['Animal Name']] = row['MorphMarket # of Listings'];
              });
              
              // Build allAnimals array
              allAnimals = Object.keys(speciesData).map(name => ({
                name: name,
                listings: dataMap.hasOwnProperty(name) ? dataMap[name] : null
              }));
              
              setupEventListeners();
              filterAnimals(); // Initial render
            })
            .catch(error => {
              console.error('Error loading availability data:', error);
              // Fallback: render without availability data
              allAnimals = Object.keys(speciesData).map(name => ({
                name: name,
                listings: null
              }));
              setupEventListeners();
              filterAnimals();
            });
        }

        // Start when DOM is ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', init);
        } else {
          init();
        }
    </script>
</body>
</html>
