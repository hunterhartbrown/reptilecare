<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Page: All Care Guides
         Purpose: Displays grid of available reptile care guides with availability indicators.
         Dev notes: Card UI/styles come from css/styles.css. Data loaded from data/availability.json. -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Care Guides - ReptileCare</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header id="main-header"></header>
    <section class="section dark care-guides">
        <div class="container">
            <h1 class="mt-0 text-center">All Care Guides</h1>
            <p class="text-center">Here you can find all the care guides for various reptiles.</p>
            <div class="grid" id="care-guides-list"></div>
        </div>
    </section>
    <div id="main-footer"></div>
    <script src="js/scripts.js"></script>
    <!-- JSON to Cards Script -->
    <script>
        // 1. Availability thresholds
        const thresholds = [
          { min: 1000, label: "Very Common", segments: 5 },
          { min: 200,  label: "Common",      segments: 4 },
          { min: 50,   label: "Uncommon",    segments: 3 },
          { min: 20,   label: "Rare",        segments: 2 },
          { min: 5,    label: "Very Rare",   segments: 1 },
          { min: 0,    label: "Exceedingly Rare", segments: 0 }
        ];
        function getAvailability(listings) {
          for (let t of thresholds) {
            if (listings >= t.min) return t;
          }
          return thresholds[thresholds.length - 1];
        }
        // Map animal name to image + care guide url
        const animalInfo = {
          "Leopard Gecko": {
            img: "images/leo trans bg.png",
            url: "leopard-gecko.html",
            enclosureId: "leopard-gecko"
          },
          "Bearded Dragon": {
            img: "images/bearded drag trans bg.png",
            url: "bearded-dragon.html",
            enclosureId: "bearded-dragon"
          },
          "Crested Gecko": {
            img: "images/crested gecko trans bg.png",
            url: "crested-gecko.html",
            enclosureId: "crested-gecko"
          },
          "Eastern Collared Lizard": {
            img: "images/collared lizard trans bg.png",
            url: "eastern-collared-lizard.html",
            enclosureId: "eastern-collared-lizard"
          }
        };
        // Build care guide card HTML
        function buildCareGuideCard(animal, listings, info) {
          let bar = '';
          let availText = '';
          if (typeof listings === 'number' && !isNaN(listings)) {
            const availability = getAvailability(listings);
            for (let i = 0; i < 5; ++i) {
              bar += `<span class="seg${i < availability.segments ? ' active' : ''}"></span>`;
            }
            availText = `${listings} - ${availability.label}`;
          } else {
            for (let i = 0; i < 5; ++i) bar += `<span class="seg"></span>`;
            availText = 'No Data';
          }
          return `
            <div class="care-card" data-animal="${animal}">
              <div class="thumb">
                <img src="${info.img}" alt="${animal}" loading="lazy" onerror="this.onerror=null;this.src='images/no-image.png';" />
              </div>
              <div class="title js-animal-label">${animal}</div>
              <div class="availability">
                <div class="bar">${bar}</div>
                <div class="muted">${availText}</div>
              </div>
              <div class="btn-row">
                <a class="btn btn-outline" href="${info.url}">Guide</a>
                <a class="btn btn-solid" href="enclosure-builder.html?reptile=${info.enclosureId}">Enclosure</a>
              </div>
            </div>
          `;
        }
        // Fetch JSON and build cards
        fetch('data/availability.json')
          .then(response => response.json())
          .then(animals => {
            // Create a lookup map from the JSON
            const dataMap = {};
            animals.forEach(row => {
              dataMap[row['Animal Name']] = row['MorphMarket # of Listings'];
            });
            // Now always render ALL animals in animalInfo
            const container = document.getElementById('care-guides-list');
            let html = '';
            Object.entries(animalInfo).forEach(([animal, info]) => {
              const listings = dataMap.hasOwnProperty(animal) ? dataMap[animal] : null;
              html += buildCareGuideCard(animal, listings, info);
            });
            container.innerHTML = html;
            // Now dynamically size the animal names for uniformity
            uniformizeLabelFontSize();
          });

        // Function to adjust label font size for uniform row heights
        function uniformizeLabelFontSize() {
          const labels = document.querySelectorAll('.js-animal-label');
          let fontSize = 1.07; // Starting font size in rem
          const minFontSize = 0.78; // Minimum font size in rem
          const step = 0.02; // Smaller step for more precise adjustment

          labels.forEach(label => {
            label.style.fontSize = fontSize + 'rem';
          });

          // Keep reducing font size until no label overflows
          let hasOverflow = true;
          while (hasOverflow && fontSize > minFontSize) {
            hasOverflow = false;
            labels.forEach(label => {
              if (label.scrollHeight > 44) { // 44px is our fixed height
                hasOverflow = true;
              }
            });
            
            if (hasOverflow) {
              fontSize -= step;
              labels.forEach(label => {
                label.style.fontSize = fontSize + 'rem';
              });
            }
          }
        }
    </script>
</body>
</html>
